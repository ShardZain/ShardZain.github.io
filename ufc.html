<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MMA Pick'em</title>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; padding:20px; }
    h1,h2 { text-align:center; }
    .card { background:#fff; padding:15px; margin:20px auto; border-radius:8px; max-width:500px;
            box-shadow:0 2px 5px rgba(0,0,0,0.2);}
    input, select { width:100%; padding:8px; margin:5px 0; }
    button { width:100%; padding:10px; margin-top:10px; border:none; border-radius:6px;
             background:#007bff; color:#fff; cursor:pointer;}
    button:hover { background:#0056b3; }
    table { width:100%; border-collapse:collapse; margin-top:10px;}
    th,td { border:1px solid #ccc; padding:8px; text-align:center;}
  </style>
</head>
<body>

<h1>MMA Pick'em</h1>

<!-- Login -->
<div class="card" id="authSection">
  <h2>Login / Sign Up</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button onclick="signUp()">Sign Up</button>
  <button onclick="login()">Login</button>
</div>

<!-- Fight Card -->
<div class="card" id="fightSection" style="display:none;">
  <h2>Upcoming Fights</h2>
  <div id="fightList"></div>
  <button onclick="submitPicks()">Submit Picks</button>
</div>

<!-- Leaderboard -->
<div class="card" id="leaderboardSection" style="display:none;">
  <h2>Leaderboard</h2>
  <table>
    <thead><tr><th>User</th><th>Points</th></tr></thead>
    <tbody id="leaderboard"></tbody>
  </table>
</div>

<!-- Admin -->
<div class="card" id="adminSection" style="display:none;">
  <h2>Admin: Enter Results</h2>
  <div id="adminFights"></div>
  <button onclick="saveResults()">Save Results & Update Scores</button>
</div>

<script>
  // 1. Firebase Setup
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT",
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentUser = null;

  // 2. Auth Functions
  function signUp() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    auth.createUserWithEmailAndPassword(email, password)
      .then(() => alert("Account created!"))
      .catch(err => alert(err.message));
  }

  function login() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    auth.signInWithEmailAndPassword(email, password)
      .then(userCred => {
        currentUser = userCred.user;
        document.getElementById("authSection").style.display="none";
        document.getElementById("fightSection").style.display="block";
        document.getElementById("leaderboardSection").style.display="block";
        loadFights();
        loadLeaderboard();
      })
      .catch(err => alert(err.message));
  }

  // 3. Load Fights
  async function loadFights() {
    const snapshot = await db.collection("fights").get();
    const fightList = document.getElementById("fightList");
    const adminFights = document.getElementById("adminFights");
    fightList.innerHTML = "";
    adminFights.innerHTML = "";

    snapshot.forEach(doc => {
      const fight = doc.data();
      const id = doc.id;

      // User pick form
      fightList.innerHTML += `
        <div>
          <p><strong>${fight.fighter1} vs ${fight.fighter2}</strong></p>
          <select id="pickWinner-${id}">
            <option value="">--Winner--</option>
            <option value="${fight.fighter1}">${fight.fighter1}</option>
            <option value="${fight.fighter2}">${fight.fighter2}</option>
          </select>
          <select id="pickMethod-${id}">
            <option value="">--Method--</option>
            <option value="KO/TKO">KO/TKO</option>
            <option value="Submission">Submission</option>
            <option value="Decision">Decision</option>
          </select>
        </div>
      `;

      // Admin result input
      adminFights.innerHTML += `
        <div>
          <p><strong>${fight.fighter1} vs ${fight.fighter2}</strong></p>
          <input id="resultWinner-${id}" placeholder="Winner">
          <input id="resultMethod-${id}" placeholder="Method">
        </div>
      `;
    });
  }

  // 4. Submit Picks
  async function submitPicks() {
    const snapshot = await db.collection("fights").get();
    snapshot.forEach(doc => {
      const id = doc.id;
      const winner = document.getElementById(`pickWinner-${id}`).value;
      const method = document.getElementById(`pickMethod-${id}`).value;
      if (winner) {
        db.collection("picks").doc(`${currentUser.uid}_${id}`).set({
          user: currentUser.email,
          userId: currentUser.uid,
          fightId: id,
          pickedWinner: winner,
          pickedMethod: method
        });
      }
    });
    alert("Picks submitted!");
  }

  // 5. Save Results + Update Scores
  async function saveResults() {
    const snapshot = await db.collection("fights").get();
    snapshot.forEach(async doc => {
      const id = doc.id;
      const winner = document.getElementById(`resultWinner-${id}`).value;
      const method = document.getElementById(`resultMethod-${id}`).value;

      if (winner) {
        await db.collection("fights").doc(id).update({winner, method});

        // Update scores
        const picksSnap = await db.collection("picks").where("fightId","==",id).get();
        picksSnap.forEach(async pickDoc => {
          const pick = pickDoc.data();
          let points = 0;
          if (pick.pickedWinner === winner) {
            points += 10;
            if (pick.pickedMethod === method) points += 5;
          }
          // Update user points
          const userRef = db.collection("users").doc(pick.userId);
          const userData = await userRef.get();
          let total = userData.exists ? userData.data().points || 0 : 0;
          total += points;
          userRef.set({email: pick.user, points: total});
        });
      }
    });
    alert("Results saved and scores updated!");
    loadLeaderboard();
  }

  // 6. Leaderboard
  async function loadLeaderboard() {
    const snapshot = await db.collection("users").orderBy("points","desc").get();
    const tbody = document.getElementById("leaderboard");
    tbody.innerHTML = "";
    snapshot.forEach(doc => {
      const u = doc.data();
      tbody.innerHTML += `<tr><td>${u.email}</td><td>${u.points || 0}</td></tr>`;
    });
  }
</script>

</body>
</html>
